<!DOCTYPE html>
<html>
<head>
    <title>Link Profiler Monitor</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; padding: 20px; margin: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .metric { display: inline-block; margin: 10px; padding: 15px; background: #e3f2fd; border-radius: 4px; min-width: 150px; text-align: center; }
        .metric h3 { margin: 0 0 5px 0; color: #1976d2; }
        .metric .value { font-size: 24px; font-weight: bold; color: #333; }
        .satellite { background: #f0f8f0; margin: 5px 0; padding: 10px; border-radius: 4px; border-left: 44px solid #4caf50; }
        .satellite.offline { background: #fef0f0; border-left-color: #f44336; }
        .satellite.paused { background: #fffbe6; border-left-color: #ffc107; } /* New style for paused satellites */
        .satellite-details { font-size: 0.9em; color: #555; margin-top: 5px; } /* New style for satellite details */
        .job-row { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; }
        .status-completed { color: #4caf50; font-weight: bold; }
        .status-failed { color: #f44336; font-weight: bold; }
        .status-pending { color: #ff9800; font-weight: bold; }
        .status-in_progress { color: #2196f3; font-weight: bold; }
        .status-cancelled { color: #9e9e9e; font-weight: bold; }
        .refresh-info { color: #666; font-size: 12px; float: right; }
        h1 { color: #333; }
        h2 { color: #555; border-bottom: 2px solid #ddd; padding-bottom: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f2f2f2; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input[type="text"], .form-group input[type="number"], .form-group textarea, .form-group select {
            width: calc(100% - 20px);
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .button-group button {
            padding: 10px 15px;
            margin-right: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .button-group button.secondary { background-color: #f44336; }
        .button-group button.warning { background-color: #ff9800; }
        .button-group button:hover { opacity: 0.9; }
        .job-actions button, .satellite-actions button {
            padding: 5px 10px;
            margin-left: 5px;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }
        .job-actions button.cancel, .satellite-actions button.shutdown { background-color: #f44336; }
        .satellite-actions button.pause { background-color: #ff9800; }
        .job-actions button:hover, .satellite-actions button:hover { opacity: 0.9; }
        /* New style for global job status indicator */
        .global-status-indicator {
            font-size: 0.7em;
            font-weight: normal;
            margin-left: 10px;
        }
        .confirmation-option {
            margin-top: 10px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
        }
        .confirmation-option input {
            margin-right: 5px;
        }
    </style>
    <script>
        // IMPORTANT: These values are now injected by the backend (Link_Profiler/monitoring/dashboard.py)
        // Do NOT hardcode them here. They are passed from the Jinja2 template.
        const ACCESS_TOKEN = '{{ access_token }}'; 
        const API_BASE_URL = '{{ api_base_url }}'; 

        let disableConfirmations = false; // New: Global flag to disable confirmations

        // --- START: ACCESS TOKEN WARNING ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!ACCESS_TOKEN || ACCESS_TOKEN === 'None' || ACCESS_TOKEN === 'YOUR_ACCESS_TOKEN') {
                const warningDiv = document.createElement('div');
                warningDiv.style.backgroundColor = '#ffe0b2'; // Light orange
                warningDiv.style.border = '1px solid #ff9800'; // Orange border
                warningDiv.style.padding = '15px';
                warningDiv.style.margin = '20px auto';
                warningDiv.style.maxWidth = '800px';
                warningDiv.style.borderRadius = '8px';
                warningDiv.style.textAlign = 'center';
                warningDiv.style.fontWeight = 'bold';
                warningDiv.style.color = '#e65100'; // Dark orange text
                warningDiv.innerHTML = `
                    <p>⚠️ <strong>WARNING: ACCESS TOKEN NOT CONFIGURED!</strong></p>
                    <p>The dashboard could not obtain an access token from the main API.</p>
                    <p>Please ensure:</p>
                    <ol style="text-align: left;">
                        <li>Your main API (coordinator service) is running and accessible at <code>${API_BASE_URL}</code>.</li>
                        <li>You have configured <code>monitoring.monitor_auth.username</code> and <code>monitoring.monitor_auth.password</code> in <code>Link_Profiler/config/config.yaml</code>.</li>
                        <li>A user with these credentials exists in your main API's database (register via <code>${API_BASE_URL}/auth/register</code>).</li>
                    </ol>
                    <p>API interactions (submitting jobs, controlling satellites) will not work until this is resolved.</p>
                    <p>Check your browser's developer console (F12) and the <strong>monitor service logs</strong> for network errors (e.g., 401 Unauthorized, connection refused).</p>
                `;
                document.body.insertBefore(warningDiv, document.body.firstChild);
            }

            // Event listener for the new checkbox
            const disableConfirmationsCheckbox = document.getElementById('disableConfirmations');
            if (disableConfirmationsCheckbox) {
                disableConfirmationsCheckbox.addEventListener('change', (event) => {
                    disableConfirmations = event.target.checked;
                    console.log('Disable Confirmations checkbox changed. New value:', disableConfirmations); // Debugging log
                });
            }
        });
        // --- END: ACCESS TOKEN WARNING ---

        async function callApi(endpoint, method = 'GET', body = null) {
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${ACCESS_TOKEN}`
            };
            const options = { method, headers };
            if (body) {
                options.body = JSON.stringify(body);
            }

            console.log(`Calling API: ${method} ${API_BASE_URL}${endpoint}`); // Debugging log
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error(`API call failed for ${endpoint}:`, response.status, errorData); // Debugging log
                    throw new Error(errorData.detail || `API Error: ${response.statusText}`);
                }
                const responseData = await response.json();
                console.log(`API call successful for ${endpoint}:`, responseData); // Debugging log
                return responseData;
            } catch (error) {
                console.error(`Error during API call to ${endpoint}:`, error); // Debugging log
                throw error;
            }
        }

        async function submitNewJob() {
            const targetUrl = document.getElementById('newJobTargetUrl').value;
            const initialSeedUrls = document.getElementById('newJobInitialSeedUrls').value.split(',').map(s => s.trim()).filter(s => s);
            const jobType = document.getElementById('newJobType').value;
            const priority = parseInt(document.getElementById('newJobPriority').value);
            const configJson = document.getElementById('newJobConfig').value;
            const scheduledAt = document.getElementById('newJobScheduledAt').value;
            const cronSchedule = document.getElementById('newJobCronSchedule').value;

            let config = {};
            if (configJson) {
                try {
                    config = JSON.parse(configJson);
                } catch (e) {
                    alert('Invalid JSON in Config field: ' + e.message);
                    return;
                }
            }
            config.job_type = jobType; // Ensure job_type is in config

            const jobData = {
                target_url: targetUrl,
                initial_seed_urls: initialSeedUrls,
                config: config,
                priority: priority
            };

            if (scheduledAt) {
                jobData.scheduled_at = scheduledAt;
            }
            if (cronSchedule) {
                jobData.cron_schedule = cronSchedule;
            }

            try {
                const result = await callApi('/api/jobs/submit', 'POST', jobData);
                alert('Job submitted: ' + result.job_id);
                loadStats(); // Refresh dashboard
            } catch (error) {
                alert('Error submitting job: ' + error.message);
                console.error('Error submitting job:', error);
            }
        }

        async function pauseAllJobs() {
            console.log('Attempting to pause all jobs. disableConfirmations:', disableConfirmations); // Debugging log
            if (!disableConfirmations && !confirm('Are you sure you want to pause all job processing? This will prevent satellites from picking up new jobs globally.')) return;
            try {
                const result = await callApi('/api/jobs/pause_all', 'POST');
                alert(result.message);
                loadStats();
            } catch (error) {
                alert('Error pausing jobs: ' + error.message);
                console.error('Error pausing jobs:', error);
            }
        }

        async function resumeAllJobs() {
            console.log('Attempting to resume all jobs. disableConfirmations:', disableConfirmations); // Debugging log
            if (!disableConfirmations && !confirm('Are you sure you want to resume all job processing?')) return;
            try {
                const result = await callApi('/api/jobs/resume_all', 'POST');
                alert(result.message);
                loadStats();
            } catch (error) {
                alert('Error resuming jobs: ' + error.message);
                console.error('Error resuming jobs:', error);
            }
        }

        async function shutdownAllSatellites() {
            console.log('Attempting to shutdown all satellites. disableConfirmations:', disableConfirmations); // Debugging log
            if (!disableConfirmations && !confirm('WARNING: Are you sure you want to SHUTDOWN ALL satellites? This will terminate their processes.')) return;
            try {
                const result = await callApi('/api/satellites/control/all/shutdown', 'POST');
                alert(result.message);
                loadStats();
            } catch (error) {
                alert('Error shutting down satellites: ' + error.message);
                console.error('Error shutting down satellites:', error);
            }
        }

        async function restartAllSatellites() {
            console.log('Attempting to restart all satellites. disableConfirmations:', disableConfirmations); // Debugging log
            if (!disableConfirmations && !confirm('WARNING: Are you sure you want to RESTART ALL satellites? This will terminate their processes and rely on external process managers to restart them.')) return;
            try {
                const result = await callApi('/api/satellites/control/all/restart', 'POST');
                alert(result.message);
                loadStats();
            } catch (error) {
                alert('Error restarting satellites: ' + error.message);
                console.error('Error restarting satellites:', error);
            }
        }

        async function controlSatellite(crawlerId, command) {
            let confirmationMessage = '';
            if (command === 'SHUTDOWN') {
                confirmationMessage = `Are you sure you want to SHUTDOWN satellite ${crawlerId}? This will terminate its process.`;
            } else if (command === 'RESTART') {
                confirmationMessage = `Are you sure you want to RESTART satellite ${crawlerId}? This will terminate its process and rely on external process managers to restart it.`;
            } else if (command === 'PAUSE') {
                confirmationMessage = `Are you sure you want to PAUSE satellite ${crawlerId}? It will stop picking up new jobs.`;
            } else if (command === 'RESUME') {
                confirmationMessage = `Are you sure you want to RESUME satellite ${crawlerId}? It will start picking up new jobs.`;
            }

            console.log(`Attempting to ${command.toLowerCase()} satellite ${crawlerId}. disableConfirmations:`, disableConfirmations); // Debugging log
            if (!disableConfirmations && !confirm(confirmationMessage)) return;

            try {
                const result = await callApi(`/api/satellites/control/${crawlerId}/${command}`, 'POST');
                alert(result.message);
                loadStats();
            } catch (error) {
                alert(`Error ${command.toLowerCase()}ing satellite ${crawlerId}: ` + error.message);
                console.error(`Error ${command.toLowerCase()}ing satellite:`, error);
            }
        }

        async function cancelJob(jobId) {
            console.log(`Attempting to cancel job ${jobId}. disableConfirmations:`, disableConfirmations); // Debugging log
            if (!disableConfirmations && !confirm(`Are you sure you want to cancel job ${jobId}?`)) return;
            try {
                const result = await callApi(`/api/jobs/${jobId}/cancel`, 'POST');
                alert(result.message);
                loadStats();
            } catch (error) {
                alert(`Error cancelling job ${jobId}: ` + error.message);
                console.error('Error cancelling job:', error);
            }
        }

        async function viewJobDetails(jobId) {
            try {
                const details = await callApi(`/api/jobs/${jobId}`);
                alert('Job Details for ' + jobId + ':\n' + JSON.stringify(details, null, 2));
            } catch (error) {
                alert(`Error fetching job details for ${jobId}: ` + error.message);
                console.error('Error fetching job details:', error);
            }
        }

        async function loadJobsTable() {
            const jobsTableBody = document.getElementById('jobsTableBody');
            jobsTableBody.innerHTML = '<tr><td colspan="9">Loading jobs...</td></tr>';
            try {
                const allJobs = await callApi('/api/jobs/all');
                console.log('Received all jobs data:', allJobs); // Debugging log: Check the actual data received
                let tableHtml = '';
                if (allJobs && allJobs.length > 0) {
                    allJobs.forEach(job => {
                        const statusClass = `status-${job.status.toLowerCase().replace(' ', '_')}`;
                        tableHtml += `
                            <tr>
                                <td>${job.job_id.substring(0, 8)}...</td>
                                <td>${job.job_type}</td>
                                <td>${job.target_url}</td>
                                <td class="${statusClass}">${job.status.toUpperCase()}</td>
                                <td>${job.progress_percentage.toFixed(1)}%</td>
                                <td>${new Date(job.created_date).toLocaleString()}</td>
                                <td>${job.started_date ? new Date(job.started_date).toLocaleString() : 'N/A'}</td>
                                <td>${job.completed_date ? new Date(job.completed_date).toLocaleString() : 'N/A'}</td>
                                <td class="job-actions">
                                    <button onclick="viewJobDetails('${job.job_id}')">View</button>
                                    ${job.status !== 'COMPLETED' && job.status !== 'FAILED' && job.status !== 'CANCELLED' ? `<button class="cancel" onclick="cancelJob('${job.job_id}')">Cancel</button>` : ''}
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    tableHtml = '<tr><td colspan="9">No jobs found.</td></tr>';
                }
                jobsTableBody.innerHTML = tableHtml;
            } catch (error) {
                jobsTableBody.innerHTML = `<tr><td colspan="9" class="status-error">Error loading jobs: ${error.message}</td></tr>`;
                console.error('Error loading jobs table:', error);
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                console.log('Received general stats data:', data); // Debugging log
                
                // Update Queue Metrics
                document.querySelector('.card:nth-of-type(1) .metric:nth-of-type(1) .value').textContent = data.queue_metrics.pending_jobs || 0;
                document.querySelector('.card:nth-of-type(1) .metric:nth-of-type(2) .value').textContent = data.queue_metrics.active_satellites || 0;
                document.querySelector('.card:nth-of-type(1) .metric:nth-of-type(3) .value').textContent = data.queue_metrics.results_pending || 0;
                document.querySelector('.card:nth-of-type(1) .metric:nth-of-type(4) .value').textContent = (data.performance_stats.success_rate || 0).toFixed(1) + '%';

                // Update Data Summaries
                document.querySelector('.card:nth-of-type(2) .metric:nth-of-type(1) .value').textContent = data.data_summaries.total_link_profiles || 0;
                document.querySelector('.card:nth-of-type(2) .metric:nth-of-type(2) .value').textContent = (data.data_summaries.avg_link_profile_authority || 'N/A');
                document.querySelector('.card:nth-of-type(2) .metric:nth-of-type(3) .value').textContent = data.data_summaries.total_domains_analyzed || 0;
                document.querySelector('.card:nth-of-type(2) .metric:nth-of-type(4) .value').textContent = data.data_summaries.valuable_expired_domains || 0;
                document.querySelector('.card:nth-of-type(2) .metric:nth-of-type(5) .value').textContent = data.data_summaries.competitive_keyword_analyses || 0;
                document.querySelector('.card:nth-of-type(2) .metric:nth-of-type(6) .value').textContent = data.data_summaries.total_backlinks_stored || 0;

                // System Stats
                document.getElementById('system-stats').innerHTML = `
                    <div class="metric"><span>CPU Usage:</span><span>${(data.system.cpu_percent || 0).toFixed(1)}%</span></div>
                    <div class="metric"><span>Memory Usage:</span><span>${(data.system.memory.percent || 0).toFixed(1)}%</span></div>
                    <div class="metric"><span>Disk Usage:</span><span>${(data.system.disk.percent || 0).toFixed(1)}%</span></div>
                    <div class="metric"><span>Uptime:</span><span>${Math.floor((data.system.uptime || 0) / 3600)} hours</span></div>
                `;
                
                // API Health
                const apiHealthDiv = document.getElementById('api-health');
                const healthStatus = data.api_health.status || 'unknown';
                const healthClass = healthStatus === 'healthy' ? 'status-healthy' : 'status-unhealthy';
                apiHealthDiv.innerHTML = `
                    <div class="metric"><span>Status:</span><span class="${healthClass}">${healthStatus}</span></div>
                    <div class="metric"><span>Timestamp:</span><span>${data.api_health.timestamp || 'N/A'}</span></div>
                    <div class="metric"><span>Redis:</span><span>${data.api_health.dependencies?.redis?.status || 'Unknown'}</span></div>
                    <div class="metric"><span>PostgreSQL:</span><span>${data.api_health.dependencies?.postgresql?.status || 'Unknown'}</span></div>
                `;
                
                // Redis Stats
                const redisStatsDiv = document.getElementById('redis-stats');
                const redisStatus = data.redis.status || 'error';
                const redisClass = redisStatus === 'connected' ? 'status-healthy' : 'status-unhealthy';
                redisStatsDiv.innerHTML = `
                    <div class="metric"><span>Status:</span><span class="${redisClass}">${redisStatus}</span></div>
                    <div class="metric"><span>Connected Clients:</span><span>${data.redis.connected_clients || 0}</span></div>
                    <div class="metric"><span>Memory Used:</span><span>${data.redis.used_memory_human || '0B'}</span></div>
                    <div class="metric"><span>Keyspace Hits:</span><span>${data.redis.keyspace_hits || 0}</span></div>
                `;
                
                // Database Stats
                const dbStatsDiv = document.getElementById('database-stats');
                const dbStatus = data.database.status || 'error';
                const dbClass = dbStatus === 'connected' ? 'status-healthy' : 'status-unhealthy';
                let dbHtml = `<div class="metric"><span>Status:</span><span class="${dbClass}">${dbStatus}</span></div>`;
                if (data.database.tables && data.database.tables.length > 0) {
                    dbHtml += '<table><tr><th>Table</th><th>Inserts</th><th>Updates</th><th>Deletes</th></tr>';
                    data.database.tables.forEach(table => {
                        dbHtml += `<tr><td>${table.table}</td><td>${table.inserts}</td><td>${table.updates}</td><td>${table.deletes}</td></tr>`;
                    });
                    dbHtml += '</table>';
                } else if (dbStatus === 'connected') {
                    dbHtml += '<p>No table statistics available or database is empty.</p>';
                }
                dbStatsDiv.innerHTML = dbHtml;

                // Update Satellite Crawlers
                const satellitesDiv = document.getElementById('satellite-crawlers');
                if (data.queue_metrics.satellites && data.queue_metrics.satellites.length > 0) {
                    let satelliteHtml = '';
                    data.queue_metrics.satellites.forEach(satellite => {
                        let statusClass = '';
                        if (satellite.status === 'stale') {
                            statusClass = 'offline';
                        } else if (satellite.is_locally_paused) { /* New: Check local pause status */
                            statusClass = 'paused';
                        }
                        satelliteHtml += `
                            <div class="satellite ${statusClass}">
                                <strong>${satellite.crawler_id}</strong> 
                                (${satellite.region || 'unknown'})
                                - Last seen: ${satellite.last_seen ? new Date(satellite.last_seen).toLocaleTimeString() : 'Never'}
                                ${satellite.current_job ? `- Processing: ${satellite.current_job}` : ''}
                                <div class="satellite-details">
                                    <span>Jobs: ${satellite.total_jobs_completed || 0}</span>
                                    <span>Errors: {{ satellite.total_errors_encountered | default(0) }}</span>
                                    <span>Running: {{ satellite.running_jobs | default(0) }}</span>
                                </div>
                                <div class="satellite-actions">
                                    <button onclick="controlSatellite('${satellite.crawler_id}', 'PAUSE')" class="pause">Pause</button>
                                    <button onclick="controlSatellite('${satellite.crawler_id}', 'RESUME')">Resume</button>
                                    <button onclick="controlSatellite('${satellite.crawler_id}', 'SHUTDOWN')" class="shutdown">Shutdown</button>
                                    <button onclick="controlSatellite('${satellite.crawler_id}', 'RESTART')">Restart</button>
                                </div>
                            </div>
                        `;
                    });
                    satellitesDiv.innerHTML = satelliteHtml;
                } else {
                    satellitesDiv.innerHTML = '<p>No active satellites detected</p>';
                }

                // Update Recent Jobs
                const jobHistoryDiv = document.getElementById('recent-jobs');
                if (data.job_history && data.job_history.length > 0) {
                    let jobHtml = '';
                    data.job_history.slice(0, 10).forEach(job => { // Limit to 10 for display
                        jobHtml += `
                            <div class="job-row">
                                <span>${job.job_id.substring(0, 8)}...</span>
                                <span class="status-${job.status}">${job.status.toUpperCase()}</span>
                                <span>${job.urls_crawled} URLs</span>
                                <span>${job.links_found} links</span>
                                <span>${job.duration_seconds}s</span>
                            </div>
                        `;
                    });
                    jobHistoryDiv.innerHTML = jobHtml;
                } else {
                    jobHistoryDiv.innerHTML = '<p>No recent job history available.</p>';
                }

                // Update global job status indicator
                const globalJobStatusSpan = document.getElementById('globalJobStatus');
                if (globalJobStatusSpan) {
                    // This now calls the dashboard's own API endpoint, which proxies to main API
                    const isGlobalPaused = await fetch('/api/jobs/is_paused').then(res => res.json()).then(data => data.is_paused).catch(() => false);
                    if (isGlobalPaused) {
                        globalJobStatusSpan.textContent = '(PAUSED)';
                        globalJobStatusSpan.style.color = '#ff9800'; // Orange for paused
                    } else {
                        globalJobStatusSpan.textContent = '(ACTIVE)';
                        globalJobStatusSpan.style.color = '#4CAF50'; // Green for active
                    }
                }

                // Update last refresh time
                document.querySelector('.refresh-info').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;

            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('system-stats').innerHTML = '<p class="status-error">Error loading data.</p>';
                document.getElementById('api-health').innerHTML = '<p class="status-error">Error loading data.</p>';
                document.getElementById('redis-stats').innerHTML = '<p class="status-error">Error loading data.</p>';
                document.getElementById('database-stats').innerHTML = '<p class="status-error">Error loading data.</p>';
                document.getElementById('satellite-crawlers').innerHTML = '<p class="status-error">Error loading data.</p>';
                document.getElementById('recent-jobs').innerHTML = '<p class="status-error">Error loading data.</p>';
                const globalJobStatusSpan = document.getElementById('globalJobStatus');
                if (globalJobStatusSpan) {
                    globalJobStatusSpan.textContent = '(ERROR)';
                    globalJobStatusSpan.style.color = '#f44336';
                }
            }
            // Always load the full jobs table after other stats
            loadJobsTable();
        }
        
        // Load stats on page load and refresh every 30 seconds
        document.addEventListener('DOMContentLoaded', loadStats);
        setInterval(loadStats, 30000);
    </script>
</head>
<body>
    <div class="container">
        <h1>🔗 Link Profiler Monitor <span class="refresh-info">Last updated: {{ refresh_time }}</span></h1>
        
        <div class="card">
            <h2>📊 Queue Metrics</h2>
            <div class="metric">
                <h3>Pending Jobs</h3>
                <div class="value">{{ queue_metrics.pending_jobs or 0 }}</div>
            </div>
            <div class="metric">
                <h3>Active Satellites</h3>
                <div class="value">{{ queue_metrics.active_satellites or 0 }}</div>
            </div>
            <div class="metric">
                <h3>Results Pending</h3>
                <div class="value">{{ queue_metrics.results_pending or 0 }}</div>
            </div>
            <div class="metric">
                <h3>Success Rate</h3>
                <div class="value">{{ "%.1f"|format(performance_stats.success_rate or 0) }}%</div>
            </div>
        </div>
        
        <div class="card">
            <h2>📈 Data Summaries</h2>
            <div class="metric">
                <h3>Total Link Profiles</h3>
                <div class="value">{{ data_summaries.total_link_profiles or 0 }}</div>
            </div>
            <div class="metric">
                <h3>Avg. LP Authority</h3>
                <div class="value">{{ "%.2f"|format(data_summaries.avg_link_profile_authority or 0) }}</div>
            </div>
            <div class="metric">
                <h3>Domains Analyzed</h3>
                <div class="value">{{ data_summaries.total_domains_analyzed or 0 }}</div>
            </div>
            <div class="metric">
                <h3>Valuable Expired</h3>
                <div class="value">{{ data_summaries.valuable_expired_domains or 0 }}</div>
            </div>
            <div class="metric">
                <h3>Comp. Keyword Analyses</h3>
                <div class="value">{{ data_summaries.competitive_keyword_analyses or 0 }}</div>
            </div>
            <div class="metric">
                <h3>Total Backlinks Stored</h3>
                <div class="value">{{ data_summaries.total_backlinks_stored or 0 }}</div>
            </div>
        </div>

        <div class="card">
            <h2>📊 System Resources</h2>
            <div id="system-stats">
                <div class="metric"><span>CPU Usage:</span><span>{{ "%.1f"|format(system.cpu_percent or 0) }}%</span></div>
                <div class="metric"><span>Memory Usage:</span><span>{{ "%.1f"|format(system.memory.percent or 0) }}%</span></div>
                <div class="metric"><span>Disk Usage:</span><span>{{ "%.1f"|format(system.disk.percent or 0) }}%</span></div>
                <div class="metric"><span>Uptime:</span><span>{{ (system.uptime // 3600) if system.uptime else 0 }} hours</span></div>
            </div>
        </div>
        
        <div class="card">
            <h2>🏥 API Health</h2>
            <div id="api-health">
                {% set health_status = api_health.status or 'unknown' %}
                {% set health_class = 'status-healthy' if health_status == 'healthy' else 'status-unhealthy' %}
                <div class="metric"><span>Status:</span><span class="{{ health_class }}">{{ health_status }}</span></div>
                <div class="metric"><span>Timestamp:</span><span>{{ api_health.timestamp or 'N/A' }}</span></div>
                <div class="metric"><span>Redis:</span><span>{{ api_health.dependencies?.redis?.status or 'Unknown' }}</span></div>
                <div class="metric"><span>PostgreSQL:</span><span>{{ api_health.dependencies?.postgresql?.status or 'Unknown' }}</span></div>
            </div>
        </div>
        
        <div class="card">
            <h2>📈 Redis Statistics</h2>
            <div id="redis-stats">
                {% set redis_status = redis_stats.status or 'error' %}
                {% set redis_class = 'status-healthy' if redis_status == 'connected' else 'status-unhealthy' %}
                <div class="metric"><span>Status:</span><span class="{{ redis_class }}">{{ redis_status }}</span></div>
                <div class="metric"><span>Connected Clients:</span><span>{{ redis_stats.connected_clients or 0 }}</span></div>
                <div class="metric"><span>Memory Used:</span><span>{{ redis_stats.used_memory_human or '0B' }}</span></div>
                <div class="metric"><span>Keyspace Hits:</span><span>{{ redis_stats.keyspace_hits or 0 }}</span></div>
            </div>
        </div>
        
        <div class="card">
            <h2>🗄️ Database Statistics</h2>
            <div id="database-stats">
                {% set db_status = database_stats.status or 'error' %}
                {% set db_class = 'status-healthy' if db_status == 'connected' else 'status-unhealthy' %}
                <div class="metric"><span>Status:</span><span class="{{ db_class }}">{{ db_status }}</span></div>
                {% if database_stats.tables %}
                <table>
                    <tr><th>Table</th><th>Inserts</th><th>Updates</th><th>Deletes</th></tr>
                    {% for table in database_stats.tables %}
                    <tr>
                        <td>{{ table.table }}</td>
                        <td>{{ table.inserts }}</td>
                        <td>{{ table.updates }}</td>
                        <td>{{ table.deletes }}</td>
                    </tr>
                    {% endfor %}
                </table>
                {% else %}
                <p>No table statistics available or database is empty.</p>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <h2>🛰️ Satellite Crawlers</h2>
            <div id="satellite-crawlers">
                {% if queue_metrics.satellites %}
                    {% for satellite in queue_metrics.satellites %}
                    <div class="satellite {% if satellite.status == 'stale' %}offline{% elif satellite.is_locally_paused %}paused{% endif %}">
                        <strong>{{ satellite.crawler_id }}</strong> 
                        ({{ satellite.region or 'unknown' }})
                        - Last seen: {{ satellite.last_seen.strftime('%H:%M:%S') if satellite.last_seen else 'Never' }}
                        {% if satellite.current_job %}
                        - Processing: {{ satellite.current_job }}
                        {% endif %}
                        <div class="satellite-details">
                            <span>Jobs: {{ satellite.total_jobs_completed or 0 }}</span>
                            <span>Errors: {{ satellite.total_errors_encountered | default(0) }}</span>
                            <span>Running: {{ satellite.running_jobs | default(0) }}</span>
                        </div>
                        <div class="satellite-actions">
                            <button onclick="controlSatellite('{{ satellite.crawler_id }}', 'PAUSE')" class="pause">Pause</button>
                            <button onclick="controlSatellite('{{ satellite.crawler_id }}', 'RESUME')">Resume</button>
                            <button onclick="controlSatellite('{{ satellite.crawler_id }}', 'SHUTDOWN')" class="shutdown">Shutdown</button>
                            <button onclick="controlSatellite('{{ satellite.crawler_id }}', 'RESTART')">Restart</button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p>No active satellites detected</p>
                {% endif %}
            </div>
        </div>
        
        <div class="card">
            <h2>📈 Recent Jobs</h2>
            <div id="recent-jobs">
                {% for job in job_history[:10] %}
                <div class="job-row">
                    <span>{{ job.job_id[:8] }}...</span>
                    <span class="status-{{ job.status }}">{{ job.status.upper() }}</span>
                    <span>{{ job.urls_crawled }} URLs</span>
                    <span>{{ job.links_found }} links</span>
                    <span>{{ job.duration_seconds }}s</span>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="card">
            <h2>⚙️ New Job Submission</h2>
            <div class="form-group">
                <label for="newJobTargetUrl">Target URL:</label>
                <input type="text" id="newJobTargetUrl" value="https://example.com" required>
            </div>
            <div class="form-group">
                <label for="newJobInitialSeedUrls">Initial Seed URLs (comma-separated):</label>
                <input type="text" id="newJobInitialSeedUrls" value="https://example.com/page1, https://example.com/page2">
            </div>
            <div class="form-group">
                <label for="newJobType">Job Type:</label>
                <select id="newJobType">
                    <option value="backlink_discovery">Backlink Discovery</option>
                    <option value="link_health_audit">Link Health Audit</option>
                    <option value="technical_audit">Technical Audit</option>
                    <option value="full_seo_audit">Full SEO Audit</option>
                    <option value="domain_analysis">Domain Analysis</option>
                    <option value="web3_crawl">Web3 Crawl</option>
                    <option value="social_media_crawl">Social Media Crawl</option>
                    <option value="content_gap_analysis">Content Gap Analysis</option>
                    <option value="prospect_identification">Prospect Identification</option>
                    <option value="report_generation">Report Generation</option>
                </select>
            </div>
            <div class="form-group">
                <label for="newJobPriority">Priority (1-10):</label>
                <input type="number" id="newJobPriority" value="5" min="1" max="10">
            </div>
            <div class="form-group">
                <label for="newJobScheduledAt">Scheduled At (ISO format, e.g., 2024-12-31T23:59:59):</label>
                <input type="text" id="newJobScheduledAt" placeholder="Optional">
            </div>
            <div class="form-group">
                <label for="newJobCronSchedule">Cron Schedule (e.g., 0 0 * * *):</label>
                <input type="text" id="newJobCronSchedule" placeholder="Optional">
            </div>
            <div class="form-group">
                <label for="newJobConfig">Additional Config (JSON):</label>
                <textarea id="newJobConfig" placeholder='{"render_javascript": true}'></textarea>
            </div>
            <div class="button-group">
                <button onclick="submitNewJob()">Submit Job</button>
            </div>
        </div>

        <div class="card">
            <h2>⚙️ Global Job & Satellite Controls <span id="globalJobStatus" class="global-status-indicator"></span></h2>
            <div class="button-group">
                <button onclick="pauseAllJobs()" class="secondary">Pause All Jobs</button>
                <button onclick="resumeAllJobs()">Resume All Jobs</button>
                <button onclick="shutdownAllSatellites()" class="secondary">Shutdown All Satellites</button>
                <button onclick="restartAllSatellites()" class="warning">Restart All Satellites</button>
            </div>
            <div class="confirmation-option">
                <input type="checkbox" id="disableConfirmations">
                <label for="disableConfirmations">Disable Confirmation Pop-ups</label>
            </div>
        </div>

        <div class="card">
            <h2>⚙️ All Jobs</h2>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Type</th>
                        <th>Target</th>
                        <th>Status</th>
                        <th>Progress</th>
                        <th>Created</th>
                        <th>Started</th>
                        <th>Completed</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="jobsTableBody">
                    <!-- Jobs will be loaded here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</body>
</html>
