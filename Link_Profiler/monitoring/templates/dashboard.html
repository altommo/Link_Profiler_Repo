<!DOCTYPE html>
<html>
<head>
    <title>Link Profiler Monitor</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; padding: 20px; margin: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .metric { display: inline-block; margin: 10px; padding: 15px; background: #e3f2fd; border-radius: 4px; min-width: 150px; text-align: center; }
        .metric h3 { margin: 0 0 5px 0; color: #1976d2; }
        .metric .value { font-size: 24px; font-weight: bold; color: #333; }
        .satellite { background: #f0f8f0; margin: 5px 0; padding: 10px; border-radius: 4px; border-left: 44px solid #4caf50; }
        .satellite.offline { background: #fef0f0; border-left-color: #f44336; }
        .satellite.paused { background: #fffbe6; border-left-color: #ffc107; } /* New style for paused satellites */
        .satellite-details { font-size: 0.9em; color: #555; margin-top: 5px; } /* New style for satellite details */
        .job-row { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; }
        .status-completed { color: #4caf50; font-weight: bold; }
        .status-failed { color: #f44336; font-weight: bold; }
        .status-pending { color: #ff9800; font-weight: bold; }
        .status-in_progress { color: #2196f3; font-weight: bold; }
        .status-cancelled { color: #9e9e9e; font-weight: bold; }
        .refresh-info { color: #666; font-size: 12px; float: right; }
        h1 { color: #333; }
        h2 { color: #555; border-bottom: 2px solid #ddd; padding-bottom: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f2f2f2; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input[type="text"], .form-group input[type="number"], .form-group textarea, .form-group select {
            width: calc(100% - 20px);
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .button-group button {
            padding: 10px 15px;
            margin-right: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .button-group button.secondary { background-color: #f44336; }
        .button-group button.warning { background-color: #ff9800; }
        .button-group button:hover { opacity: 0.9; }
        .job-actions button, .satellite-actions button {
            padding: 5px 10px;
            margin-left: 5px;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }
        .job-actions button.cancel, .satellite-actions button.shutdown { background-color: #f44336; }
        .satellite-actions button.pause { background-color: #ff9800; }
        .job-actions button:hover, .satellite-actions button:hover { opacity: 0.9; }
        /* New style for global job status indicator */
        .global-status-indicator {
            font-size: 0.7em;
            font-weight: normal;
            margin-left: 10px;
        }
        .confirmation-option {
            margin-top: 10px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
        }
        .confirmation-option input {
            margin-right: 5px;
        }
    </style>
    <script>
        // IMPORTANT: Replace 'YOUR_ACCESS_TOKEN' with a valid token obtained from your /auth/token endpoint.
        // For security, in a production environment, this token should be managed securely (e.g., via a login form).
        const ACCESS_TOKEN = 'YOUR_ACCESS_TOKEN'; 
        const API_BASE_URL = ''; // Use relative path if dashboard and API are on same host/port, or full URL if different (e.g., 'http://127.0.0.1:8000')

        let disableConfirmations = false; // New: Global flag to disable confirmations

        // --- START: ACCESS TOKEN WARNING ---
        document.addEventListener('DOMContentLoaded', () => {
            if (ACCESS_TOKEN === 'YOUR_ACCESS_TOKEN') {
                const warningDiv = document.createElement('div');
                warningDiv.style.backgroundColor = '#ffe0b2'; // Light orange
                warningDiv.style.border = '1px solid #ff9800'; // Orange border
                warningDiv.style.padding = '15px';
                warningDiv.style.margin = '20px auto';
                warningDiv.style.maxWidth = '800px';
                warningDiv.style.borderRadius = '8px';
                warningDiv.style.textAlign = 'center';
                warningDiv.style.fontWeight = 'bold';
                warningDiv.style.color = '#e65100'; // Dark orange text
                warningDiv.innerHTML = `
                    <p>⚠️ <strong>WARNING: ACCESS TOKEN NOT CONFIGURED!</strong></p>
                    <p>Please replace <code>'YOUR_ACCESS_TOKEN'</code> in <code>dashboard.html</code> with a valid token from your API's <code>/auth/token</code> endpoint.</p>
                    <p>API interactions (submitting jobs, controlling satellites) will not work until this is resolved.</p>
                    <p>Check your browser's developer console (F12) for network errors (e.g., 401 Unauthorized).</p>
                `;
                document.body.insertBefore(warningDiv, document.body.firstChild);
            }

            // Event listener for the new checkbox
            const disableConfirmationsCheckbox = document.getElementById('disableConfirmations');
            if (disableConfirmationsCheckbox) {
                disableConfirmationsCheckbox.addEventListener('change', (event) => {
                    disableConfirmations = event.target.checked;
                    console.log('Disable Confirmations:', disableConfirmations); // Debugging log
                });
            }
        });
        // --- END: ACCESS TOKEN WARNING ---

        async function callApi(endpoint, method = 'GET', body = null) {
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${ACCESS_TOKEN}`
            };
            const options = { method, headers };
            if (body) {
                options.body = JSON.stringify(body);
            }

            console.log(`Calling API: ${method} ${API_BASE_URL}${endpoint}`); // Debugging log
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error(`API call failed for ${endpoint}:`, response.status, errorData); // Debugging log
                    throw new Error(errorData.detail || `API Error: ${response.statusText}`);
                }
                const responseData = await response.json();
                console.log(`API call successful for ${endpoint}:`, responseData); // Debugging log
                return responseData;
            } catch (error) {
                console.error(`Error during API call to ${endpoint}:`, error); // Debugging log
                throw error;
            }
        }

        async function submitNewJob() {
            const targetUrl = document.getElementById('newJobTargetUrl').value;
            const initialSeedUrls = document.getElementById('newJobInitialSeedUrls').value.split(',').map(s => s.trim()).filter(s => s);
            const jobType = document.getElementById('newJobType').value;
            const priority = parseInt(document.getElementById('newJobPriority').value);
            const configJson = document.getElementById('newJobConfig').value;
            const scheduledAt = document.getElementById('newJobScheduledAt').value;
            const cronSchedule = document.getElementById('newJobCronSchedule').value;

            let config = {};
            if (configJson) {
                try {
                    config = JSON.parse(configJson);
                } catch (e) {
                    alert('Invalid JSON in Config field: ' + e.message);
                    return;
                }
            }
            config.job_type = jobType; // Ensure job_type is in config

            const jobData = {
                target_url: targetUrl,
                initial_seed_urls: initialSeedUrls,
                config: config,
                priority: priority
            };

            if (scheduledAt) {
                jobData.scheduled_at = scheduledAt;
            }
            if (cronSchedule) {
                jobData.cron_schedule = cronSchedule;
            }

            try {
                const result = await callApi('/api/jobs/submit', 'POST', jobData);
                alert('Job submitted: ' + result.job_id);
                loadStats(); // Refresh dashboard
            } catch (error) {
                alert('Error submitting job: ' + error.message);
                console.error('Error submitting job:', error);
            }
        }

        async function pauseAllJobs() {
            console.log('Attempting to pause all jobs. disableConfirmations:', disableConfirmations); // Debugging log
            if (!disableConfirmations && !confirm('Are you sure you want to pause all job processing? This will prevent satellites from picking up new jobs globally.')) return;
            try {
                const result = await callApi('/api/jobs/pause_all', 'POST');
                alert(result.message);
                loadStats();
            } catch (error) {
                alert('Error pausing jobs: ' + error.message);
                console.error('Error pausing jobs:', error);
            }
        }

        async function resumeAllJobs() {
            console.log('Attempting to resume all jobs. disableConfirmations:', disableConfirmations); // Debugging log
            if (!disableConfirmations && !confirm('Are you sure you want to resume all job processing?')) return;
            try {
                const result = await callApi('/api/jobs/resume_all', 'POST');
                alert(result.message);
                loadStats();
            } catch (error) {
                alert('Error resuming jobs: ' + error.message);
                console.error('Error resuming jobs:', error);
            }
        }

        async function shutdownAllSatellites() {
            console.log('Attempting to shutdown all satellites. disableConfirmations:', disableConfirmations); // Debugging log
            if (!disableConfirmations && !confirm('WARNING: Are you sure you want to SHUTDOWN ALL satellites? This will terminate their processes.')) return;
            try {
                const result = await callApi('/api/satellites/control/all/shutdown', 'POST');
                alert(result.message);
                loadStats();
            }<ctrl63>